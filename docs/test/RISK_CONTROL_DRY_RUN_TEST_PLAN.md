# 風控系統 DRY_RUN 測試計畫

> 版本: 1.0  
> 日期: 2025-12-09  
> 狀態: 待執行

## 1. 測試目標

- 驗證風控邏輯正確性
- 確認軟限制行為符合預期
- 測試 SL/TP 觸發機制
- 確保無資金風險下完整測試

---

## 2. 環境準備

### 2.1 啟動 DRY_RUN 模式

```bash
# 設定環境變數
set DRY_RUN=true
set DRY_RUN_INITIAL_BALANCE=10000

# 啟動服務
go run .
```

### 2.2 初始風控設定

```json
{
  "enable_risk": true,
  "max_total_exposure": 5000,
  "max_daily_loss": 500,
  "max_daily_trades": 20,
  "warning_threshold": 0.8,
  "caution_threshold": 0.9,
  "caution_size_ratio": 0.5,
  "default_stop_loss": 0.02,
  "default_take_profit": 0.05
}
```

---

## 3. 測試案例

### 3.1 基本功能測試

| # | 測試項目 | 操作 | 預期結果 | 狀態 |
|---|----------|------|----------|------|
| T1 | 正常訂單 | 下單 $100 | 訂單通過 | [ ] |
| T2 | 風控關閉 | `enable_risk=false` + 下單 | 跳過所有檢查 | [ ] |
| T3 | 策略風控關閉 | 策略 `enable_risk=false` | 跳過策略檢查 | [ ] |

### 3.2 軟限制測試

| # | 測試項目 | 操作 | 預期結果 | 狀態 |
|---|----------|------|----------|------|
| T4 | 80% 警告 | 累計虧損 $400 後下單 | 通過 + 警告 Log | [ ] |
| T5 | 90% 縮單 | 累計虧損 $450 後下單 $1000 | 訂單縮至 $500 | [ ] |
| T6 | 100% 拒絕 | 累計虧損 $500 後下單 | 訂單被拒絕 | [ ] |

### 3.3 分層風控測試

| # | 測試項目 | 操作 | 預期結果 | 狀態 |
|---|----------|------|----------|------|
| T7 | 策略倉位上限 | 策略 A 下單超過 MaxPositionSize | 訂單被調整或拒絕 | [ ] |
| T8 | 策略 SL/TP 覆蓋 | 策略設定 SL=3%, 全局 SL=2% | 使用 3% | [ ] |
| T9 | 多策略獨立 | 策略 A 達上限，策略 B 下單 | 策略 B 正常 | [ ] |

### 3.4 SL/TP 觸發測試

| # | 測試項目 | 操作 | 預期結果 | 狀態 |
|---|----------|------|----------|------|
| T10 | 止損觸發 | 開倉後價格下跌超過 SL | 觸發平倉 | [ ] |
| T11 | 止盈觸發 | 開倉後價格上漲超過 TP | 觸發平倉 | [ ] |
| T12 | per-strategy SL/TP | 多策略同標的觸發 | 各自獨立處理 | [ ] |

### 3.5 保護機制測試

| # | 測試項目 | 操作 | 預期結果 | 狀態 |
|---|----------|------|----------|------|
| T13 | Panic Recovery | 模擬處理異常 | 餘額正確釋放 | [ ] |
| T14 | WAL 恢復 | 重啟服務 | 未完成訂單恢復 | [ ] |
| T15 | 訂單重試 | 模擬網路錯誤 | 重試 3 次 | [ ] |

---

## 4. 測試步驟

### 4.1 階段一：基本驗證 (Day 1)

```
1. 啟動 DRY_RUN 模式
2. 執行 T1-T3 基本功能測試
3. 確認 Log 輸出正確
4. 確認 Metrics 計數正確
```

### 4.2 階段二：軟限制 (Day 1)

```
1. 重置測試環境
2. 手動累計虧損至 80%
3. 執行 T4-T6 軟限制測試
4. 觀察訂單調整行為
```

### 4.3 階段三：分層風控 (Day 2)

```
1. 配置多策略風控設定
2. 執行 T7-T9 分層測試
3. 確認策略設定正確覆蓋
```

### 4.4 階段四：SL/TP (Day 2)

```
1. 開啟模擬價格波動
2. 執行 T10-T12 SL/TP 測試
3. 確認觸發時機正確
```

### 4.5 階段五：保護機制 (Day 2)

```
1. 模擬異常場景
2. 執行 T13-T15 保護機制測試
3. 確認系統恢復正確
```

---

## 5. 驗證標準

### 5.1 必須通過

- [ ] 所有 T1-T6 測試通過
- [ ] Metrics 計數正確 (`checks_total`, `rejections_total`)
- [ ] 無 panic 或未捕獲的錯誤

### 5.2 建議通過

- [ ] T7-T12 分層 + SL/TP 測試
- [ ] T13-T15 保護機制測試

---

## 6. 測試記錄

### 6.1 測試結果

| 日期 | 測試項目 | 結果 | 備註 |
|------|----------|------|------|
| | | | |

### 6.2 發現問題

| # | 問題描述 | 嚴重度 | 狀態 |
|---|----------|--------|------|
| | | | |

---

## 7. 上線檢查清單

- [ ] 所有必須通過項目完成
- [ ] 無嚴重問題待修
- [ ] 風控設定已調整為正式值
- [ ] DRY_RUN=false 確認
- [ ] 監控告警已設定

---

## 8. 自動化測試腳本

### 8.1 腳本位置

```
backend/cmd/trading-core/scripts/test/
├── setup-dry-run.ps1       # 環境設定
├── test-risk-control.ps1   # 主測試腳本
└── test-soft-limits.ps1    # 軟限制互動測試
```

### 8.2 快速開始

```powershell
# 1. 設定環境並啟動服務
cd backend/cmd/trading-core/scripts/test
.\setup-dry-run.ps1

# 2. 開啟新終端，執行測試
.\test-risk-control.ps1

# 3. 互動式軟限制測試
.\test-soft-limits.ps1
```

### 8.3 腳本參數

**test-risk-control.ps1**
| 參數 | 說明 | 預設值 |
|------|------|--------|
| `-BaseUrl` | API 位址 | http://localhost:8080/api |
| `-Verbose` | 詳細輸出 | false |
| `-SkipSoftLimits` | 跳過軟限制測試 | false |
| `-SkipLayered` | 跳過分層測試 | false |

**test-soft-limits.ps1**
| 參數 | 說明 | 預設值 |
|------|------|--------|
| `-TargetLossPercent` | 目標虧損百分比 | 80 |
| `-MaxDailyLoss` | 最大日虧損 | 500 |
| `-WatchMode` | 即時監控模式 | false |

**setup-dry-run.ps1**
| 參數 | 說明 | 預設值 |
|------|------|--------|
| `-InitialBalance` | 初始餘額 | 10000 |
| `-ResetDB` | 重置資料庫 | false |
