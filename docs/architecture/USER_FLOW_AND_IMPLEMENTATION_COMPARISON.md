# DES v2.0 用戶使用流程與現有實作對照

> 以「一般使用者使用策略交易工具」的角度，整理完整流程，並對照 DES v2.0 目前已實作／部分實作／尚未實作的部分，作為後續產品設計與開發優先順序的參考。

---

## 1. 註冊、登入與初始設定

**理想用戶流程**
- 在平台註冊帳號、完成 Email／手機驗證。
- 完成風險屬性問卷（投資年資、虧損承受度、槓桿經驗等）。
- 綁定券商／交易所帳戶（例如 Binance），輸入 API Key／Secret 或使用 OAuth。
- 設定偏好：顯示幣別、時區、通知管道（推播／Email／即時通）。

**目前 DES v2.0 狀態**
- Backend 以 Binance 為主要交易所，已支援：
  - 市場資料串流：`internal/market` + Binance WebSocket。
  - 下單通路：`internal/order` + Binance REST／User Data Stream。
  - API 金鑰設定：透過 `.env` (`BINANCE_API_KEY`, `BINANCE_API_SECRET`) 管理。
- 尚未看到：
  - 一般「平台帳號／登入系統」與使用者管理。
  - 前端 UI 讓使用者輸入與管理多組交易 API 金鑰。
  - 風險屬性問卷與個人偏好設定頁。

**結論**
- 「連接交易所」部分已由後端支援，但目前是以環境變數方式配置，尚未有以「使用者帳號」為中心的設定流程與 UI。

---

## 2. 瀏覽策略市場／策略清單

**理想用戶流程**
- 進入「策略市場／策略清單」頁面。
- 根據資產類型、風格、風險等級、交易頻率等條件進行篩選。
- 點進策略詳細頁觀看：
  - 歷史回測績效（報酬、最大回撤、勝率、Sharpe 等）。
  - 交易頻率、持有時間、是否使用槓桿。

**目前 DES v2.0 狀態**
- 策略引擎：
  - 內建多種策略：`internal/strategy`（MA Cross, RSI, Bollinger 等）。
  - 策略實例配置：`strategies.yaml` 定義 `strategy_type`, `symbol`, `interval`, `parameters`, `is_active` 等欄位。
  - 資料庫 Schema：`strategy_instances`, `strategy_positions` 等表用於記錄實例與持倉。
- API 與前端：
  - `docs/setup/QUICK_REFERENCE.md` 中 API：
    - `GET /api/strategies`：列出策略。
    - `POST /api/strategies/:id/start/pause/stop/panic`：控制策略。
  - 前端 Dashboard 有策略列表與基本控制 UI（依現有描述）。
- 尚未看到：
  - 完整的「策略市場」概念（分類、標籤、風格、風險等級）。
  - 回測績效指標（Sharpe、最大回撤、勝率）在 UI 上的展示與查詢。

**結論**
- 已具備「策略實例列表 + 基本控制」能力，但仍偏向開發者／操作者介面，尚未發展成「面向一般用戶」的策略市場或社群策略瀏覽體驗。

---

## 3. 回測與模擬交易（紙上交易）

**理想用戶流程**
- 在啟用實盤前，用戶會：
  - 先對策略做歷史回測（調整時間區間、標的、交易成本假設）。
  - 再以「模擬交易／紙上交易」模式跑一段時間，確認與回測結果接近。
- 用戶會觀察：
  - 實際交易訊號頻率。
  - 下單成功率、滑價情況。
  - 回撤與波動是否在可接受範圍。

**目前 DES v2.0 狀態**
- Dry Run／紙上交易：
  - `DRY_RUN=true`（見 `docs/setup/QUICK_REFERENCE.md`）可啟動 Dry Run 模式：
    - 策略照常運行、產生訊號與模擬訂單。
    - 不會對交易所送出真實下單。
  - 風險管理與持倉狀態仍會在系統內被更新。
- 回測功能：
  - 在現有文件中，尚未描述「離線歷史回測引擎」（針對過去 N 年資料回放）的模組。
  - 現有架構偏向「即時行情 + 事件流 + 實時策略運作」。

**結論**
- DES v2.0 已具備「Dry Run 模式」，可以扮演「即時紙上交易」的角色。
- 尚未有「大規模歷史資料回測」的明確設計與對應 UI，因此「啟用前回測比較」這一段流程目前支援度有限。

---

## 4. 風險與資金配置（策略啟用前的設定）

**理想用戶流程**
- 在上實盤前，用戶會設定：
  - 策略使用的總資金比例（例如總資金的 30%）。
  - 單一標的最大持倉比例。
  - 單筆、單日最大虧損，以及最大連續虧損筆數。
  - 是否使用槓桿，以及槓桿倍數上限。

**目前 DES v2.0 狀態**
- 風險管理模組：
  - `internal/risk` 定義 `Manager`，負責根據 `Config`、目前持倉與帳戶狀態，評估每筆策略訊號：
    - 控制每筆下單大小（% of capital）。
    - 設定 Stop Loss / Take Profit。
    - 實作 Daily loss limit 等限制（見 `.env` 範例變數）。
  - `.env` 中示例：
    - `MAX_POSITION_SIZE`（單策略資金比例）。
    - `DAILY_LOSS_LIMIT`（每日最大虧損）。
    - `STOP_LOSS_PERCENT`（停損百分比）。
- 前端與設定方式：
  - 目前由環境變數與後端 Config 控制，尚未有「使用者在 UI 中調整風險參數」的流程。

**結論**
- 核心風控邏輯已存在且相對完整，但操作面仍偏向工程配置；距離「一般用戶在介面中調整策略風險／資金」的體驗，還需要：
  - 前端風控設定畫面。
  - 後端 API 用於讀寫 per-user／per-strategy 的風險設定。

---

## 5. 正式啟用實盤交易

**理想用戶流程**
- 用戶在策略詳情頁：
  - 選擇「使用真實帳戶啟用」。
  - 指定要使用的交易帳戶與投入金額。
  - 最後確認摘要（策略、標的、風險限制），按下「啟用」。
- 首日通常會密切觀察策略執行情況與下單成功率。

**目前 DES v2.0 狀態**
- 啟動與控制：
  - API 端點：
    - `POST /api/strategies/:id/start`：啟用策略。
    - `POST /api/strategies/:id/pause`：暫停策略。
    - `POST /api/strategies/:id/stop`：停止策略。
    - `POST /api/strategies/:id/panic`：Panic Sell／強制平倉。
  - 策略實例與狀態由資料庫表與 `strategy_instances.status` 管理。
- 實際下單：
  - `internal/order` 模組負責 Dry Run／Live Mode 的下單執行。
  - 與 Binance 的實際交易串接已存在（在系統架構中有描述）。
- 現有缺口：
  - per-user／per-account 的顯式映射尚未在文檔中出現（目前較像是整個系統對一組交易 API）。
  - 啟動策略時「顯示最終確認摘要」目前由前端決定，文檔中尚未有專門的 API／流程描述。

**結論**
- 從「系統」角度來看，啟用實盤所需能力幾乎都有。
- 從「用戶流程」角度，還缺少：
  - 多帳戶／多 API Key 管理。
  - 啟用流程中的風險提示與確認頁。

---

## 6. 日常監控與報表

**理想用戶流程**
- 每日或每週用戶會：
  - 查看 Dashboard：當日損益、累積損益、持倉明細。
  - 檢視交易通知（下單成功／失敗、策略停用、風險觸發）。
  - 定期檢查策略表現是否偏離歷史水準，決定是否降風險或暫停。

**目前 DES v2.0 狀態**
- Dashboard 與 API：
  - `GET /api/orders`：查詢訂單。
  - `GET /api/positions`：查詢策略持倉。
  - `GET /api/balance`：查詢資金餘額。
  - 後端有完整事件流：`internal/events`（PriceTick, StrategySignal, OrderFilled, RiskAlert 等）。
  - 前端 React Dashboard 透過 `frontend/src/api.js` 呼叫上述 API。
- 報表與歷史績效：
  - 資料庫中有 PnL、交易記錄與持倉表，可以支持報表生成。
  - 文檔中尚未有「視覺化績效報表」的詳細設計（例如策略等級的 Equity Curve、回撤圖）。
- 通知機制：
  - 目前主要為系統內部 log／Dashboard 查詢，尚未有「推播／Email」型通知描述。

**結論**
- DES v2.0 已有日常監控所需的核心資料與 API。
- 若要達到「一般用戶」期待的體驗，還可加強：
  - 策略級報表與視覺化圖表。
  - 下單失敗／風險事件的主動通知機制。

---

## 7. 策略調整、版本管理與 A/B 測試

**理想用戶流程**
- 用戶會：
  - 調整策略參數（停損幅度、進出場條件、持倉上限等）。
  - 為不同設定建立版本（V1, V1.1, V2），同時跑小額實盤 + 模擬比較。
  - 決定何時切換到新版策略，並平滑地關閉舊版。

**目前 DES v2.0 狀態**
- 策略參數：
  - `strategies.yaml` 可以為每個實例設定參數（例如 MA 週期、Size 等）。
  - `PUT /api/strategies/:id/params`：提供修改策略參數的 API。
- 版本管理：
  - 文檔中尚未定義「版本」欄位或策略版本管理流程。
  - 策略實例可以透過新增不同 id 來模擬版本（例如 `macd_eth_v1`, `macd_eth_v2`），但沒有專門的 UI／邏輯。
- 模擬與實盤並行：
  - 透過 Dry Run + Live Mode 技術上可以並行（不同策略 id／不同設定）。
  - 目前屬於「工程可行」層級，尚未形成面向用戶的清晰操作流程。

**結論**
- DES v2.0 具備「調整參數」與「多實例」的技術基礎。
- 若要實現用戶心目中的「策略版本管理／A-B 測試」，需在：
  - 資料模型上加入版本／標籤。
  - 前端提供版本切換與比較的 UX。

---

## 8. 風險事件應對（極端行情／系統異常）

**理想用戶流程**
- 市場大波動時：
  - 用戶會降低持倉或暫停策略。
  - 必要時手動平倉或一鍵平倉。
- 系統／券商異常時：
  - 立即檢查實際持倉與掛單。
  - 等系統恢復後再決定是否重啟策略。

**目前 DES v2.0 狀態**
- 風險事件：
  - `internal/events` 中有 `EventRiskAlert` 等事件類型。
  - `internal/risk` 會在觸發特定條件時產生風險決策。
- 應對操作：
  - `POST /api/strategies/:id/panic`：Panic Sell，一鍵平倉。
  - `POST /api/strategies/:id/stop`：停止策略。
- 系統異常：
  - 文檔中有提到 logging 與故障排查流程，但較偏向開發者視角。

**結論**
- 面對「極端行情／風險事件」的操作能力基本具備。
- 尚可擴充：
  - UI 上更明確的風險警示與狀態顯示。
  - 對系統／交易所異常的告警與自動保護機制。

---

## 9. 策略退出、關閉與資料匯出

**理想用戶流程**
- 當策略不再適用時，用戶會：
  - 停止策略（選擇是否同時平倉）。
  - 匯出完整交易紀錄與損益報表（CSV／Excel）。
  - 可能再到策略市場尋找其他策略。

**目前 DES v2.0 狀態**
- 停止與平倉：
  - `POST /api/strategies/:id/stop` 與 `:id/panic` 已提供停止／強制平倉能力。
  - 是否支援「停止但保留現有部位」由策略／下單邏輯決定，文檔尚未明確。
- 資料匯出：
  - 資料庫中有完整交易、持倉與 PnL 記錄。
  - 尚未看到專門的「報表匯出 API」或前端匯出功能描述。

**結論**
- 策略關閉相關能力已存在，資料也足夠。
- 可再補強：
  - 報表與匯出功能（CSV／Excel）。
  - 策略停用流程中的 UX（是否平倉、提示稅務／風險說明等）。

---

## 10. 進階用戶：自編策略與開發流程

**理想用戶流程**
- 進階用戶會：
  - 使用平台的 SDK／腳本語言撰寫自訂策略。
  - 在線上 IDE 或本地環境撰寫、測試與 Debug。
  - 在 Sandbox／模擬環境跑一段時間，再部署到實盤。

**目前 DES v2.0 狀態**
- 開發者導向：
  - Go 後端開發者可以在 `internal/strategy` 新增策略實作。
  - 透過 `strategies.yaml` 配置策略執行。
  - 有 `docs/process/DEVELOPER_ONBOARDING.md`、`docs/architecture/SYSTEM_ARCHITECTURE.md` 等文件，說明如何擴充系統。
- 面向一般用戶的策略編輯：
  - 目前沒有類似「使用者可在 UI 中寫腳本」或「圖形化策略編輯」的設計。

**結論**
- DES v2.0 現階段較偏向「量化交易系統框架」，主要對象是工程師／量化開發者。
- 若未來要服務更廣泛的一般用戶，需額外設計：
  - 策略編輯器（腳本或可視化）。
  - 安全的 Sandbox 執行環境與權限控管。

---

## 總結：DES v2.0 與「市面策略交易工具用戶流程」的差距

- 已具備、且相對完整的部分：
  - 即時市場資料訂閱、策略引擎、風控管理、下單執行、Dry Run／實盤模式切換。
  - 以事件流（Event Bus）為核心的架構，易於擴充。
  - 基本的策略列表與控制 API，能支撐 Dashboard。
- 部分具備、但偏工程導向的部分：
  - 策略配置（YAML／環境變數）與風險參數設定。
  - 策略多實例與 Dry Run，可用來打造版本管理與 A/B 測試，但目前缺乏面向用戶的產品化流程。
- 尚未實作或缺乏產品化設計的部分：
  - 一般用戶帳號／登入系統、API 金鑰管理 UI。
  - 策略市場／社群策略瀏覽（分類、標籤、回測績效展示）。
  - 完整歷史回測引擎與績效視覺化。
  - 報表與匯出、通知與告警機制。

此文檔可作為後續產品 Roadmap 的基礎，將「用戶流程」拆成多個迭代目標：先把現有能力包裝成清晰的 UI（策略列表、風控設定、Dry Run 實盤切換），再逐步補上「策略市場」、「回測與報表」、「帳號／多帳戶管理」等更高階的功能。
