# DES-V2 開發規範（Agents）

本文件面向內部工程師，使用繁體中文撰寫，定義 DES-V2 的開發與協作規則，確保系統在安全、可維護、可預期的品質下演進。

## 協作流程
- Issue→Branch→PR：分支命名 `feature/<scope>`、`fix/<scope>`、`chore/<scope>`，PR 必附 Issue 連結與測試結果。
- Commit：簡潔命令式訊息，建議遵循 Conventional Commits；避免一次提交過多不相關變更。
- PR 內容：包含目的摘要、影響範圍、風險/回退方案、測試證明；涉及 API/DB/Proto 須同步文件或樣本。
- 審核：至少 1 位熟悉模組的 reviewer；提出人負責收斂並完成驗收。

## 代碼風格與品質
### 通用
- 格式化必跑：Go `gofmt`/`go vet`，Python `black`+`ruff`（如有），前端 `npm run lint`（如有）。
- 錯誤處理：回傳可判斷的錯誤，避免以 `panic` 取代；日誌只記必要欄位，避免敏感資訊（API Key/Token/密碼）。
- Context 傳遞：跨層呼叫必帶 `context.Context`，避免直接用 `context.Background()`；可取消路徑需支援超時/取消。
- 併發安全：共享狀態須上鎖或以 channel 封裝；goroutine/Promise 需捕捉錯誤並可關閉，避免無界緩衝。
- 配置管理：機密不入庫；提供 `.env.example`，以環境變數區分 dev/stage/prod，不硬編碼密鑰。

### Backend（Go, `backend/cmd/trading-core`）
- Go 1.21+；新模組置於 `internal/<domain>`，共用元件放 `pkg/`。
- Handler 只負責驗證與調度；業務邏輯放 service/engine，避免在 handler 阻塞 IO。
- 資料存取：schema 變更需有遷移腳本（含回退）；多表寫入用交易，批次寫入可用 `persistence.BatchWriter`。
- 測試：`go test ./...` 為基線；併發/高延遲路徑需整合測試（參考 `test/high_latency_integration_test.go`）；測試用 in-memory DB 或專用檔。
- 可靠性：與交易所互動須處理重試/速率限制；自動同步（如對帳）需可關閉並留審計。

### Python 策略層（`python/`）
- Python 3.10+，使用虛擬環境。
- 盡量加型別標註；避免全域狀態；策略配置放 YAML/JSON。
- 測試：優先 `pytest`，含 IO 的策略用假資料或 mock，確保可重現。

### 前端（`frontend/`）
- Node 18+；開發流程 `npm install && npm run dev`。
- API 呼叫集中於 `src/api.*`，統一 baseURL、攔截器與錯誤處理；組件內避免散落。
- 介面需提供明確錯誤提示，可重試；基本響應式與可及性（鍵盤操作、aria 標籤）。

## API 與 Handler 驗證
- 路徑版本：保持 `/api/v1/...`；資源用名詞，動作用 HTTP Method 區分。
- 請求驗證：使用 binding/validator 檢查必填、長度、範圍；未驗證的輸入不得直通 DB/外部 API。
- 回應格式：統一 `{"code":"...","message":"...","data":...}`，錯誤提供 machine code，避免回傳內部堆疊。
- 非同步與冪等：高延遲操作（如下單、交易所同步）採佇列/事件驅動，API 儘快回覆已受理並提供查詢；高風險操作支援 Idempotency-Key。

## 資料庫與遷移
- 遷移腳本必備 up/down；若不相容需在 PR 描述回復步驟與風險。
- 交易性保證：多表或批次寫入需在交易中；若允許部分成功，須記錄失敗明細並可重試。
- 測試資料需匿名化，禁止提交生產 dump。
- 索引/查詢調整需附 explain 或耗時對比；移除索引需說明替代方案或監控。

## 觀測性與運維
- 日誌等級：INFO 事件、WARN 可恢復、ERROR 需人工關注；敏感值一律遮蔽。
- 指標：長耗時或高頻路徑需暴露耗時/成功率/隊列深度；修改既有指標時同步更新告警門檻或文件。
- 追蹤與關閉：跨服務/協程傳遞 request-id/trace-id（若有）；背景任務支援 context 取消，Shutdown 時需 flush/close。
- 自動同步/對帳：保留審計軌跡（時間、操作者、前後狀態）；失敗可降級或重試，不得阻塞主流程。

## 安全事件處理
- 回報：發現洩漏/越權/漏洞，立即在內部安全通道通報，附重現、影響範圍、暫時緩解。
- 臨時防護：以 feature flag 或配置快速關閉受影響功能；必要時封鎖憑證或來源。
- 修復：修復 PR 需附測試與風險說明；若影響用戶資料，準備公告或影響說明。

## 註解時機與語言
- 撰寫時機：非直觀邏輯（併發順序、鎖策略、重試/退避、邊界條件）、風控假設、性能權衡、暫時性 hack/繞路（需附移除條件）應加註解或 TODO。
- 省略時機：直接描述程式碼本身的註解可省略，以清晰命名取代冗餘註解。
- 語言規範：程式碼註解與 TODO 以繁體中文撰寫；若對外開放的模組/文件需同時提供英文說明則在文件中補充。
- 放置位置：與程式碼距離近，保持單行或少量；跨模組背景放 `docs/`，在程式碼中留短鏈接或檔名。
- 標記格式：使用 `TODO(Owner,YYYY-MM)` 標註時限與責任人；需追蹤的風險附 Issue 連結。

## 可讀性 / 可維護性
- 單一職責：handler 驗證/調度；業務集中 service/engine；資料存取集中 repository/DAO。
- 命名清晰：避免魔法數字與隱晦縮寫；常數集中管理，錯誤碼可追蹤。
- 模組化：對外暴露介面/DTO；共用工具放 `pkg/`/utilities，避免重複程式。
- 文檔同步：公共介面或配置變更需更新 `docs/`/樣本/README 入口；PR 說明標註文件更新點。

## 性能與資源要求
- 非阻塞與背壓：熱路徑（訂單/行情）避免等待外部；佇列容量與 goroutine/promise 上限可配置。
- DB 效能：新增查詢/索引需驗證 explain/耗時；批次寫入優先用 `BatchWriter` 或交易；避免 handler 讀取全表。
- 併發與資源：共享狀態須上鎖或 channel；避免無界緩衝導致 OOM；長序列計算用流式或分批，必要時節流/取樣。
- 觀測與回退：性能敏感優化需暴露耗時/吞吐/錯誤率指標；高風險變更應有 feature flag 或配置開關。

## 測試策略
- 必跑：`go test ./...`；前端改動跑 `npm run build` 或可用測試；Python 策略改動跑 `pytest`（如有）。
- 邊界：涵蓋高延遲、重試、部分成交、取消競態；資料存取涵蓋失敗與重試；併發路徑需檢查競態。
- 回歸：修改共用元件（事件總線、訂單執行、風控、批次寫入、對帳）提供最小回歸測試清單。

## PR 自檢清單
1) 代碼已格式化，無 lint 報錯。  
2) 新行為有測試或手動驗證證明。  
3) 無敏感資訊（API Key/密碼/Token）進入程式或日誌。  
4) 公共介面變更已更新文件/樣本。  
5) 重大變更具備開關或回退方案，並在 PR 說明標註。
